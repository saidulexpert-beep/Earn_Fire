<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn Fire - Premium Store</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #FFD700 0%, #FDB931 50%, #C06C02 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            color: #1a1a1a;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            padding-bottom: 80px;
        }
        /* Premium Text Gradient */
        .text-premium {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
            text-shadow: 0px 2px 4px rgba(0,0,0,0.1);
        }
        
        input, textarea, #mail-details-content, #mail-purchase-history .font-mono, .selectable-text {
            -webkit-user-select: text;
            -ms-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }
        .card-bg {
            background-color: #ffffff;
            border: 1px solid #f0f0f0;
            border-radius: 20px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-gradient {
            background: linear-gradient(135deg, #111827, #374151);
            color: #FFD700;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            border: 1px solid #4b5563;
        }
        .btn-gradient:active { transform: scale(0.97); }
        
        .input-field {
            background-color: #ffffff;
            border: 2px solid #e5e7eb;
            color: #1f2937;
            transition: all 0.2s ease;
        }
        .input-field:focus {
            border-color: #FDB931;
            box-shadow: 0 0 0 4px rgba(253, 185, 49, 0.1);
            outline: none;
        }
        .main-page { display: none; }
        .main-page.active { display: flex; animation: fadeIn 0.4s ease-out; }
        .sub-page { display: none; }
        .sub-page.active { display: block; animation: fadeIn 0.3s ease-out; }

        .bottom-nav {
             background: rgba(255, 255, 255, 0.85);
             backdrop-filter: blur(20px);
             -webkit-backdrop-filter: blur(20px);
             border-top: 1px solid rgba(255, 255, 255, 0.5);
             position: fixed;
             bottom: 0;
             left: 0;
             right: 0;
             max-width: 672px;
             margin: 0 auto;
             display: flex;
             justify-content: space-around;
             align-items: center;
             padding: 10px 16px 20px 16px;
             z-index: 50;
             box-shadow: 0 -4px 30px rgba(0,0,0,0.05);
        }
        .nav-link-premium { 
            display: flex; flex-direction: column; align-items: center; gap: 4px; 
            color: #9ca3af; font-size: 0.7rem; font-weight: 600; 
            padding: 8px; border-radius: 12px; transition: all 0.2s ease; 
            position: relative; cursor: pointer; background: none; border: none; 
        }
        .nav-link-premium.active { color: #d97706; transform: translateY(-2px); }
        .nav-link-premium .icon { width: 22px; height: 22px; stroke-width: 2.5px; }
        
        .center-home-link { 
            position: relative; top: -25px; 
            background: linear-gradient(135deg, #111827, #000000);
            border: 4px solid #f8f9fa;
            border-radius: 50%; width: 60px; height: 60px; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: #FFD700;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0,0,0,0.03);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .banner-wrapper { position: relative; width: 100%; padding-top: 50%; border-radius: 20px; overflow: hidden; box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.15); }
        .banner-inner { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .slide { min-width: 100%; position: relative; }
        .slide img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .dots { position: absolute; bottom: 10px; width: 100%; text-align: center; z-index: 10; display: flex; justify-content: center; gap: 6px; }
        .dot { height: 6px; width: 6px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: all 0.3s; }
        .dot.active { background: #FFD700; width: 20px; border-radius: 10px; }

        .credit-card-bg {
            background: linear-gradient(125deg, #000000, #1a1a1a, #2d2d2d);
            border-radius: 24px;
            color: #FFD700;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
        }
        .credit-card-bg::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 60%);
            transform: rotate(30deg); pointer-events: none;
        }
        .chip { width: 45px; height: 32px; background: linear-gradient(135deg, #FFD700, #B8860B); border-radius: 8px; position: relative; overflow: hidden; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .chip::after { content: ''; position: absolute; inset: 0; border: 1px solid rgba(0,0,0,0.2); border-radius: 8px; background: repeating-linear-gradient(90deg, transparent 0, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 3px); }

        /* ========= PREMIUM LOADER ========= */
        #loader { 
            background: #ffffff; 
            z-index: 100; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .loader-logo-container {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .loader-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top-color: #FFD700;
            border-right-color: #1a1a1a;
            border-radius: 50%;
            animation: spin-slow 2s linear infinite;
        }
        .loader-ring:nth-child(2) {
            width: 70%;
            height: 70%;
            border-top-color: #1a1a1a;
            border-right-color: #FFD700;
            animation: spin-reverse 1.5s linear infinite;
        }
        .loader-icon {
            font-size: 2rem;
            color: #1a1a1a;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes spin-slow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-reverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(0.95); } }
        
        /* Sidebar Menu - RIGHT SIDE */
        #slide-out-menu {
            position: fixed;
            top: 0;
            right: 0;
            left: auto;
            width: 280px;
            height: 100%;
            background: #ffffff;
            z-index: 60;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0,0,0,0.1);
            border-left: 1px solid #f0f0f0;
        }
        #slide-out-menu.open { transform: translateX(0); }
        #menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 55;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }

        /* Mail Switcher */
        .mail-view-switcher { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            background-color: #ffffff; 
            padding: 5px; 
            border-radius: 16px; 
            border: 1px solid #f0f0f0;
        }
        .mail-view-switcher button { 
            padding: 12px; 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 0.8rem; 
            color: #6b7280; 
            background-color: transparent;
            border: none;
            transition: all 0.2s ease;
        }
        .mail-view-switcher button.active { 
            background: #111827;
            color: #FFD700; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .support-item {
            display: flex; align-items: center; justify-content: space-between;
            background: #ffffff; padding: 16px; border-radius: 12px; margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #f3f4f6;
            transition: all 0.2s; text-decoration: none; color: #1f2937;
        }
        .support-item:hover { transform: translateX(-5px); border-color: #d97706; }
        .support-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
        
        .offer-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .offer-item { position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: transform 0.2s; aspect-ratio: 9/16; background: #e5e7eb; }
        .offer-item:active { transform: scale(0.98); }
        .offer-item img { width: 100%; height: 100%; object-fit: cover; }
        
        /* BEAUTIFIED TASK ITEM */
        .task-item-premium { 
            background: white; border-radius: 16px; padding: 12px; margin-bottom: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; 
            display: flex; align-items: center; justify-content: space-between; 
            position: relative; overflow: hidden;
        }
        .task-item-premium::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary-gradient);
        }
        .task-icon-box {
            width: 40px; height: 40px; border-radius: 10px; background: #FFFBEB; 
            color: #d97706; display: flex; align-items: center; justify-content: center;
        }
        .task-reward-badge { 
            background: #FFFBEB; color: #d97706; padding: 2px 8px; border-radius: 6px; 
            font-size: 10px; font-weight: 800; border: 1px solid #FEF3C7; margin-top: 2px; display: inline-block;
        }
        
        .action-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; padding: 16px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); gap: 8px; transition: transform 0.2s; border: 1px solid #f0f0f0; }
        .action-btn:active { transform: scale(0.95); background: #f9fafb; }
        
        .review-card-new { background-color: #ffffff; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .star-rating i { color: #facc15; }

        .offer-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .offer-tab { flex: 1; padding: 12px; text-align: center; background: #ffffff; border-radius: 12px; font-size: 14px; font-weight: 600; color: #6b7280; border: 1px solid #f0f0f0; cursor: pointer; }
        .offer-tab.active { background: #111827; color: #FFD700; border-color: #111827; }

    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative">

    <!-- Premium Loading Screen -->
    <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center z-[100]">
        <div class="loader-logo-container">
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
            <i data-lucide="flame" class="loader-icon w-8 h-8 fill-yellow-400"></i>
        </div>
        <h1 class="text-3xl font-black text-premium tracking-widest mb-2">EARN FIRE</h1>
        <p class="text-[10px] text-gray-400 font-mono tracking-[0.3em] uppercase">Premium Digital Store</p>
        <div id="loader-reviews" class="absolute bottom-12 text-xs text-gray-500 font-medium opacity-0 transition-opacity duration-500 italic"></div>
    </div>

    <!-- Channel Lock Modal -->
    <div id="channel-lock-modal" class="fixed inset-0 flex flex-col items-center justify-center z-[200] bg-white hidden">
        <div class="p-8 text-center max-w-sm">
            <div class="w-20 h-20 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="lock" class="w-10 h-10 text-yellow-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Access Locked!</h2>
            <p class="text-gray-500 text-sm mb-8">You must join our official channel to use this app.</p>
            <button onclick="window.Telegram.WebApp.openLink('https://t.me/Earn_Fire')" class="w-full py-3 rounded-xl btn-gradient font-bold mb-3 shadow-lg">Join Channel</button>
            <button id="verify-join-btn" onclick="window.location.reload()" class="w-full py-3 rounded-xl bg-gray-100 text-gray-700 font-bold hover:bg-gray-200">I Joined, Verify</button>
        </div>
    </div>

    <!-- Sidebar Menu (RIGHT SIDE) -->
    <div id="menu-overlay"></div>
    <aside id="slide-out-menu">
        <div class="menu-header bg-gray-50 p-6 border-b border-gray-100">
            <h2 class="text-xl font-bold text-gray-800 font-orbitron">Support Center</h2>
            <p class="text-xs text-gray-500 mt-1">Links close automatically in 8s</p>
        </div>
        <nav id="support-channels-list" class="flex-grow overflow-y-auto p-4 bg-gray-50/50">
            <!-- Populated via JS -->
        </nav>
        <div class="p-4 text-center text-[10px] text-gray-400 border-t bg-white">
            EARN FIRE &copy; 2025
        </div>
    </aside>

    <div id="app-container" class="flex flex-col main-page">
        <!-- =========== HEADER =========== -->
        <header class="header flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="relative cursor-pointer" onclick="navigateTo('profile-page')">
                    <img id="header-profile-pic" class="w-10 h-10 rounded-full border-2 border-yellow-500 object-cover hidden" src="" alt="Profile">
                    <div id="header-initials-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-800 to-black flex items-center justify-center shadow-md border border-yellow-500"><span id="header-initials" class="text-sm font-bold text-yellow-500"></span></div>
                </div>
                <div>
                    <h1 class="text-lg font-black text-premium leading-none">EARN FIRE</h1>
                    <div class="flex items-center gap-1 mt-0.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <p id="header-welcome-name" class="text-[10px] text-gray-500 font-medium">Welcome User</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button id="notification-btn" class="relative p-2 rounded-full bg-gray-50 hover:bg-gray-100 transition-colors border border-gray-100">
                    <i data-lucide="bell" class="w-5 h-5 text-gray-700"></i>
                    <span id="notification-badge" class="notification-badge hidden">0</span>
                </button>
                <button id="hamburger-menu-btn" class="p-2 rounded-full bg-gray-50 hover:bg-gray-100 transition-colors border border-gray-100">
                    <i data-lucide="menu" class="w-5 h-5 text-gray-700"></i>
                </button>
            </div>
        </header>

        <main class="flex-grow pb-4 px-4 pt-2 space-y-4">
            <!-- =========== HOME PAGE =========== -->
            <div id="home-page" class="space-y-6 sub-page">
                <div class="banner-wrapper">
                    <div class="banner-inner" id="slides">
                        <div class="slide active"><a href="#"><img src="https://i.postimg.cc/zBp8rCX9/Yellow-Orange-Modern-Marketing-Courses-You-Tube-Thumbnail-20250910-185659-0000.png" alt="Slide 1"></a></div>
                        <div class="slide"><a href="#"><img src="https://i.postimg.cc/W1syFD8p/Grey-Blue-Illustration-Refer-a-Friend-Instagram-Post-1080-x-720-px-20250917-223749-0000.png" alt="Slide 2"></a></div>
                        <div class="slide"><a href="#"><img src="https://i.postimg.cc/52HsFwvV/Black-and-Orange-Money-You-Tube-Thumbnail-20250917-224706-0000.png" alt="Slide 3"></a></div>
                    </div>
                    <div class="dots" id="dots"></div>
                </div>

                <div class="credit-card-bg p-6 flex flex-col justify-between h-48 w-full">
                    <div class="flex justify-between items-start">
                        <div class="chip"></div>
                        <span class="text-[10px] font-mono opacity-80 tracking-[0.2em] text-yellow-500 font-bold">PREMIUM MEMBER</span>
                    </div>
                    <div class="relative z-10">
                        <p class="text-[10px] text-gray-400 font-medium mb-1 uppercase tracking-wider">Total Balance</p>
                        <h2 id="balance-display" class="text-3xl font-mono font-bold tracking-tight text-white drop-shadow-md">৳0.00</h2>
                    </div>
                    <div class="flex justify-between items-center mt-2 relative z-10">
                         <p class="text-[10px] font-mono opacity-60">**** **** **** USER</p>
                         <button id="home-deposit-btn" class="bg-gradient-to-r from-yellow-500 to-amber-600 text-black px-4 py-1.5 rounded-full text-[10px] font-bold shadow-[0_0_15px_rgba(255,215,0,0.3)] active:scale-95 transition-transform flex items-center gap-1">
                             <i data-lucide="plus-circle" class="w-3 h-3"></i> ADD FUND
                         </button>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-3">
                    <button class="action-btn" onclick="navigateTo('pay-page')">
                        <div class="p-3 bg-blue-50 rounded-full"><i data-lucide="wallet" class="w-5 h-5 text-blue-600"></i></div>
                        <span class="text-xs font-semibold text-gray-600">Deposit</span>
                    </button>
                    <button class="action-btn" onclick="navigateTo('mail-page')">
                        <div class="p-3 bg-purple-50 rounded-full"><i data-lucide="shopping-cart" class="w-5 h-5 text-purple-600"></i></div>
                        <span class="text-xs font-semibold text-gray-600">Shop</span>
                    </button>
                    <button class="action-btn" onclick="navigateTo('offer-page')">
                        <div class="p-3 bg-pink-50 rounded-full"><i data-lucide="gift" class="w-5 h-5 text-pink-600"></i></div>
                        <span class="text-xs font-semibold text-gray-600">Earn</span>
                    </button>
                    <button class="action-btn" onclick="toggleMenu()">
                        <div class="p-3 bg-green-50 rounded-full"><i data-lucide="headphones" class="w-5 h-5 text-green-600"></i></div>
                        <span class="text-xs font-semibold text-gray-600">Help</span>
                    </button>
                </div>
            </div>
            
            <!-- =========== ZONE PAGE (SELL & TASKS) =========== -->
            <div id="offer-page" class="sub-page">
                 <div class="relative flex items-center justify-center mb-4 pt-2">
                    <button onclick="navigateTo('home-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center text-gray-800">Zone</h2>
                </div>
                
                <div class="offer-tabs">
                    <button id="tab-sell" class="offer-tab active" onclick="switchOfferTab('sell')">SELL</button>
                    <button id="tab-tasks" class="offer-tab" onclick="switchOfferTab('tasks')">TASKS</button>
                </div>

                <!-- SELL SECTION -->
                <div id="offer-content-sell" class="offer-content-section">
                    <div class="card-bg p-5 space-y-4 mb-4">
                        <div class="text-center">
                            <h3 class="font-bold text-gray-800">Sell Your Assets</h3>
                            <p class="text-[10px] text-gray-500">Admin will verify and add balance.</p>
                        </div>
                        <div class="space-y-3">
                            <input id="sell-product-name" type="text" placeholder="Product Name (e.g. Gmail, FB)" class="w-full p-3 rounded-xl input-field text-sm">
                            <textarea id="sell-details" rows="3" placeholder="Details (Email:Pass:Recovery)" class="w-full p-3 rounded-xl input-field text-sm font-mono"></textarea>
                            <input id="sell-price" type="number" placeholder="Asking Price (৳)" class="w-full p-3 rounded-xl input-field text-sm">
                            <button onclick="handleSellRequest()" class="w-full p-3 rounded-xl btn-gradient text-sm uppercase">Submit Request</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm text-gray-700 mb-2 px-1">Your Sell History</h4>
                        <div id="sell-history-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- TASK SECTION (BEAUTIFIED) -->
                <div id="offer-content-tasks" class="offer-content-section" style="display:none;">
                     <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-3 text-center">
                         <p class="text-xs text-blue-700 font-semibold">Complete tasks to earn instant balance.</p>
                     </div>
                     <div id="task-list-container" class="space-y-3"></div>
                </div>
            </div>

            <!-- =========== NOTIFICATION PAGE =========== -->
            <div id="notification-page" class="sub-page">
                <div class="relative flex items-center justify-center mb-4 pt-2">
                    <button onclick="navigateTo('home-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center text-gray-800">Notifications</h2>
                </div>
                <div id="notification-list-full" class="space-y-3"></div>
            </div>

            <!-- =========== DEPOSIT PAGE =========== -->
            <div id="pay-page" class="space-y-6 sub-page">
                <h2 class="text-2xl font-bold text-center text-premium pt-2">Deposit Center</h2>
                <div class="card-bg p-5 space-y-5">
                    <div class="text-center">
                        <h3 class="font-semibold text-lg flex items-center justify-center gap-2 text-gray-800"><i data-lucide="credit-card" class="w-5 h-5 text-yellow-600"></i><span>টাকা জমা দিন</span></h3>
                        <p class="text-xs text-gray-500 mt-1">Select your preferred method</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <div class="bg-white p-3 rounded-xl text-center border hover:border-yellow-400 shadow-sm transition-all">
                            <img src="https://i.postimg.cc/Jh9s6jWw/20250922-113350.png" alt="Nagad" class="w-8 h-8 rounded-full mx-auto mb-2">
                            <p class="font-bold text-sm">নগদ</p>
                            <p class="text-gray-600 font-mono text-xs my-1">01864260513</p>
                            <button onclick="copyToClipboard('01864260513', this)" class="w-full text-[10px] py-1 bg-gray-50 rounded hover:bg-gray-100 font-bold uppercase tracking-wide border">Copy</button>
                        </div>
                        <div class="bg-white p-3 rounded-xl text-center border hover:border-pink-400 shadow-sm transition-all">
                            <img src="https://i.postimg.cc/tCwGVkdH/20250922-113514.png" alt="bKash" class="w-8 h-8 rounded-full mx-auto mb-2">
                            <p class="font-bold text-sm">বিকাশ</p>
                            <p class="text-gray-600 font-mono text-xs my-1">01827750260</p>
                            <button onclick="copyToClipboard('01827750260', this)" class="w-full text-[10px] py-1 bg-gray-50 rounded hover:bg-gray-100 font-bold uppercase tracking-wide border">Copy</button>
                        </div>
                         <div class="bg-white p-3 rounded-xl text-center border hover:border-purple-400 shadow-sm transition-all">
                            <img src="https://i.postimg.cc/htsw10Tj/20250922-113924.png" alt="Rocket" class="w-8 h-8 rounded-full mx-auto mb-2">
                            <p class="font-bold text-sm">রকেট</p>
                            <p class="text-gray-600 font-mono text-xs my-1">018277502604</p>
                            <button onclick="copyToClipboard('018277502604', this)" class="w-full text-[10px] py-1 bg-gray-50 rounded hover:bg-gray-100 font-bold uppercase tracking-wide border">Copy</button>
                        </div>
                         <div class="bg-white p-3 rounded-xl text-center border hover:border-yellow-500 shadow-sm transition-all">
                            <img src="https://i.postimg.cc/L6LFLfxY/20250922-113752.png" alt="Binance" class="w-8 h-8 rounded-full mx-auto mb-2">
                            <p class="font-bold text-sm">Binance</p>
                            <p class="text-gray-600 font-mono text-xs my-1">1105989483</p>
                            <button onclick="copyToClipboard('1105989483', this)" class="w-full text-[10px] py-1 bg-gray-50 rounded hover:bg-gray-100 font-bold uppercase tracking-wide border">Copy ID</button>
                        </div>
                    </div>

                    <div class="space-y-4 pt-2">
                         <div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">METHOD</label><select id="deposit-method" class="w-full p-3 rounded-xl input-field text-sm"><option value="">Select Method</option><option value="Nagad">নগদ</option><option value="bKash">বিকাশ</option><option value="Rocket">রকেট</option><option value="Binance">Binance</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">AMOUNT (BDT)</label><input id="deposit-amount" type="number" placeholder="e.g. 500" class="w-full p-3 rounded-xl input-field text-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">SENDER NUMBER</label><input id="sender-number" type="text" placeholder="017xxxxxxxx" class="w-full p-3 rounded-xl input-field text-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">TRX ID</label><input id="deposit-txid" type="text" placeholder="Transaction ID" class="w-full p-3 rounded-xl input-field text-sm"></div>
                        <button id="deposit-btn" class="w-full p-3 rounded-xl btn-gradient text-sm uppercase tracking-wide">Submit Request</button>
                    </div>
                </div>
                <div class="mt-6"><h3 class="text-lg font-bold mb-3 px-1">Recent Transactions</h3><div id="payment-history-list" class="space-y-3"></div></div>
            </div>

            <!-- =========== MAIL PAGE (SHOP) =========== -->
            <div id="mail-page" class="sub-page">
                 <div class="space-y-6">
                    <div class="mail-view-switcher">
                        <button id="login-mail-btn" class="active" onclick="switchMailView('login')">LOGIN</button>
                        <button id="otp-mail-btn" onclick="switchMailView('otp')">OTP</button>
                        <button id="account-mail-btn" onclick="switchMailView('account')">ACCOUNT</button>
                        <button id="number-mail-btn" onclick="switchMailView('number')">NUMBER</button>
                    </div>

                    <div id="mail-views-container">
                        <div id="login-mail-container" class="space-y-4"></div>
                        <div id="otp-mail-container" class="space-y-4" style="display:none;"></div>
                        <div id="account-mail-container" class="space-y-4" style="display:none;"></div>
                        <div id="number-mail-container" class="space-y-4" style="display:none;"></div>
                    </div>
                    
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold">Buy History</h3>
                            <div class="flex items-center gap-2">
                               <button id="copy-history-btn" class="p-2 bg-white border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50"><i data-lucide="copy" class="w-4 h-4"></i></button>
                               <button id="download-history-btn" class="p-2 bg-white border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50"><i data-lucide="download" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div id="mail-purchase-history" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- =========== UPDATES PAGE =========== -->
            <div id="updates-page" class="space-y-6 sub-page">
                <h2 class="text-xl font-bold text-center text-gray-800">Latest Update</h2>
                <div id="updates-content" class="space-y-4"></div>
                <div class="mt-8">
                    <h3 class="text-lg font-semibold text-center mb-4 text-gray-800">Customer Reviews</h3>
                    <div id="reviews-list" class="space-y-4"></div>
                </div>
            </div>

             <!-- =========== REPORT HISTORY PAGE =========== -->
             <div id="report-history-page" class="space-y-6 sub-page">
                <div class="relative flex items-center justify-center mb-4 pt-2">
                   <button onclick="navigateTo('profile-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100 transition-colors">
                       <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                   </button>
                   <h2 class="text-xl font-bold text-center text-gray-800">Report History</h2>
               </div>
               <div id="report-history-list" class="space-y-3"></div>
           </div>

            <!-- =========== PROFILE PAGE =========== -->
            <div id="profile-page" class="space-y-6 sub-page">
                <div class="card-bg p-6 flex flex-col items-center text-center mt-4">
                    <div class="relative mb-4">
                        <img id="profile-pic" class="w-24 h-24 rounded-full border-4 border-yellow-500 shadow-xl object-cover" src="" alt="Profile">
                        <div id="profile-initials-avatar" class="w-24 h-24 rounded-full bg-gradient-to-tr from-gray-800 to-black flex items-center justify-center border-4 border-yellow-500 shadow-xl hidden"><span id="profile-initials" class="text-3xl font-bold text-yellow-500"></span></div>
                    </div>
                    <h3 id="profile-name" class="text-2xl font-bold text-gray-800">Loading...</h3>
                    <p id="profile-username" class="text-gray-500 text-sm font-medium">@username</p>
                    <div class="mt-2 bg-gray-100 px-3 py-1 rounded-full text-xs font-mono text-gray-600" id="profile-id">ID: ...</div>
                </div>

                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <button id="profile-report-history-btn" class="card-bg p-4 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                            <i data-lucide="clipboard-list" class="w-6 h-6 text-orange-500"></i>
                            <span class="font-semibold text-xs text-gray-600">Report History</span>
                        </button>
                        <button id="profile-tutorial-btn" class="card-bg p-4 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                            <i data-lucide="youtube" class="w-6 h-6 text-red-500"></i>
                            <span class="font-semibold text-xs text-gray-600">Tutorials</span>
                        </button>
                    </div>

                    <button id="more-features-btn" class="w-full card-bg p-4 flex justify-between items-center text-left font-bold text-gray-700">
                        <span class="flex items-center gap-3"><i data-lucide="zap" class="w-5 h-5 text-yellow-500"></i> More Features</span>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                    </button>
                    <button id="go-to-support-btn" class="w-full card-bg p-4 flex justify-between items-center text-left font-bold text-gray-700">
                        <span class="flex items-center gap-3"><i data-lucide="headphones" class="w-5 h-5 text-blue-500"></i> Support Team</span>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                    </button>
                </div>
            </div>

            <div id="features-page" class="space-y-8 sub-page">
                 <div class="relative flex items-center justify-center mb-4 pt-2">
                    <button onclick="navigateTo('profile-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center text-gray-800">Features</h2>
                </div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="card-bg p-4">
                        <p class="text-xs text-gray-400 mb-1 uppercase font-bold">Total Sent</p>
                        <p id="total-send-display" class="text-xl font-mono font-bold text-gray-800">৳0.00</p>
                    </div>
                    <div class="card-bg p-4">
                        <p class="text-xs text-gray-400 mb-1 uppercase font-bold">Total Received</p>
                        <p id="total-receive-display" class="text-xl font-mono font-bold text-gray-800">৳0.00</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button id="features-receive-btn" class="p-4 rounded-xl font-bold text-white bg-gradient-to-r from-blue-500 to-sky-500 shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <i data-lucide="arrow-down-to-line" class="w-5 h-5"></i> Receive
                    </button>
                    <button id="features-send-btn" class="p-4 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-500 to-purple-500 shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                         <i data-lucide="send" class="w-5 h-5"></i> Send Money
                    </button>
                </div>

                <div>
                    <h3 class="text-lg font-bold mb-3">Balance Transfer History</h3>
                    <div id="transfer-history-list" class="space-y-3"></div>
                </div>
                
                 <button class="w-full card-bg p-4 flex justify-between items-center text-left font-bold text-gray-700 mt-4" onclick="navigateTo('link-team-page')">
                    <span class="flex items-center gap-3"><i data-lucide="users" class="w-5 h-5 text-indigo-500"></i> My Team</span>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>

            <div id="admin-page" class="space-y-6 sub-page">
                <h2 class="text-xl font-bold text-center text-gray-800 pt-2">Admin Panel</h2>
                
                <!-- Admin Sell Requests -->
                <div class="card-bg p-5 space-y-4">
                    <h3 class="font-bold text-gray-800">Sell Requests</h3>
                    <div id="admin-sell-requests" class="space-y-3"></div>
                </div>

                <div class="card-bg p-5 space-y-4">
                    <h3 class="font-bold text-gray-800">Add Stock</h3>
                    <div><select id="mail-type-select" class="w-full p-3 rounded-xl input-field text-sm font-semibold"></select></div>
                    <div><textarea id="mail-data-textarea" rows="8" placeholder="email/password/token" class="w-full p-3 rounded-xl input-field font-mono text-xs"></textarea></div>
                    <button id="add-mails-btn" class="w-full p-3 rounded-xl btn-gradient">Add to Stock</button>
                </div>

                <!-- Admin Task Adder -->
                <div class="card-bg p-5 space-y-4 mt-4">
                    <h3 class="font-bold text-gray-800">Add New Task</h3>
                    <select id="task-type" class="w-full p-3 rounded-xl input-field text-sm">
                        <option value="link">Web Link</option>
                        <option value="telegram">Telegram Channel (API Check)</option>
                    </select>
                    <input id="task-title" type="text" placeholder="Task Title" class="w-full p-3 rounded-xl input-field text-sm">
                    <input id="task-reward" type="text" placeholder="Reward Text (e.g. 5 Taka)" class="w-full p-3 rounded-xl input-field text-sm">
                    <input id="task-amount" type="number" placeholder="Reward Amount" class="w-full p-3 rounded-xl input-field text-sm">
                    <input id="task-link" type="text" placeholder="Link URL" class="w-full p-3 rounded-xl input-field text-sm">
                    <input id="task-target-id" type="text" placeholder="@username (Telegram Only)" class="w-full p-3 rounded-xl input-field text-sm">
                    <button id="add-task-btn" class="w-full p-3 rounded-xl btn-gradient">Add Task</button>
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-bold mb-3 text-center">Replace Requests</h3>
                    <div id="replace-requests-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="link-team-page" class="space-y-6 sub-page">
                <div class="relative flex items-center justify-center mb-4 pt-2">
                    <button onclick="navigateTo('features-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center text-gray-800">Team Management</h2>
                </div>
                <div class="card-bg p-5 space-y-5">
                     <p class="text-sm text-center text-gray-600 bg-blue-50 p-3 rounded-xl">Add friends to your team. They can use your balance to purchase items.</p>
                     <div class="flex gap-2">
                         <input id="link-friend-id" type="text" placeholder="Friend's Chat ID" class="flex-1 p-3 rounded-xl input-field text-sm">
                         <button id="search-friend-btn" class="btn-gradient px-4 rounded-xl"><i data-lucide="search" class="w-5 h-5"></i></button>
                     </div>
                     <div id="friend-search-result" class="mt-2"></div>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-bold mb-3">Team Members</h3>
                    <div id="linked-friends-list" class="space-y-3"></div>
                </div>
            </div>


            <div id="send-page" class="space-y-6 sub-page">
                <div class="relative flex items-center justify-center mb-4 pt-2">
                    <button onclick="navigateTo('features-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center text-gray-800">Send Money</h2>
                </div>
                <div class="card-bg p-5 space-y-5">
                    <div class="text-center p-2 bg-red-50 rounded-lg border border-red-100 mb-2">
                         <p class="text-xs text-red-600 font-bold">Sending Fee: 5%</p>
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">RECIPIENT ID</label><input id="send-recipient-id" type="text" placeholder="Telegram ID" class="w-full p-3 rounded-xl input-field font-mono text-sm"></div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">AMOUNT</label>
                            <input id="send-amount" type="number" placeholder="Min 20" class="w-full p-3 rounded-xl input-field font-mono text-sm">
                            <p id="send-fee-display" class="text-xs text-indigo-600 mt-1 h-4 font-semibold text-right"></p>
                        </div>
                        <button id="submit-send-btn" class="w-full p-3 rounded-xl btn-gradient text-sm uppercase font-bold">Send Now</button>
                    </div>
                </div>
            </div>
            
            <!-- =========== TUTORIAL PAGE =========== -->
            <div id="tutorial-page" class="space-y-6 sub-page">
                 <div class="relative flex items-center justify-center mb-4 pt-2">
                    <button onclick="navigateTo('profile-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center text-gray-800">Tutorials</h2>
                </div>
                <div id="tutorial-list" class="space-y-5"></div>
            </div>
        </main>

        <!-- =========== BOTTOM NAV =========== -->
        <nav class="bottom-nav">
            <a href="#" class="nav-link-premium" data-page="updates-page"><i data-lucide="bell-ring" class="icon"></i><span>Updates</span></a>
            <a href="#" class="nav-link-premium" data-page="offer-page"><i data-lucide="gift" class="icon"></i><span>Zone</span></a>
            <a href="#" class="nav-link-premium center-home-link active" data-page="home-page"><i data-lucide="layout-grid" class="icon"></i></a>
            <a href="#" class="nav-link-premium" data-page="mail-page"><i data-lucide="shopping-bag" class="icon"></i><span>Shop</span></a>
            <a href="#" class="nav-link-premium" data-page="profile-page"><i data-lucide="user-circle-2" class="icon"></i><span>Profile</span></a>
            <a href="#" id="admin-nav-link" class="nav-link-premium hidden" data-page="admin-page"><i data-lucide="shield-alert" class="icon"></i><span>Admin</span></a>
        </nav>
    </div>

    <!-- Modals -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center border shadow-2xl">
            <div class="mb-4 mx-auto w-12 h-12 bg-yellow-50 rounded-full flex items-center justify-center"><i data-lucide="info" class="w-6 h-6 text-yellow-600"></i></div>
            <p id="alert-message" class="mb-6 font-medium text-gray-800"></p>
            <button id="alert-ok-btn" class="w-full py-2.5 rounded-xl btn-gradient">OK</button>
        </div>
    </div>

    <div id="deposit-details-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
        <div class="card-bg rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold text-center text-gray-800 mb-4">Instructions</h3>
            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-600">
                <li>Select payment method.</li>
                <li>Send money to the shown number.</li>
                <li>Copy the Transaction ID (TrxID).</li>
                <li>Fill the form and submit.</li>
            </ol>
            <button id="deposit-details-ok-btn" class="w-full p-3 rounded-xl btn-gradient mt-5">Understood</button>
        </div>
    </div>

    <div id="mail-details-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
        <div class="card-bg rounded-2xl p-6 w-full max-w-md relative flex flex-col max-h-[80vh]">
            <h3 id="mail-details-title" class="text-xl font-bold text-center text-premium mb-4 shrink-0">Details</h3>
            <div id="mail-details-content" class="text-gray-700 bg-gray-50 p-4 rounded-xl text-sm leading-relaxed overflow-y-auto"></div>
            <button id="mail-details-ok-btn" class="w-full p-3 rounded-xl btn-gradient mt-4 shrink-0">Close</button>
        </div>
    </div>

    <div id="insufficient-balance-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
        <div class="card-bg rounded-2xl p-6 w-full max-w-xs text-center">
            <button id="close-insufficient-balance-modal" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="wallet" class="w-8 h-8 text-red-500"></i></div>
            <h3 class="text-lg font-bold text-gray-800">Low Balance!</h3>
            <p class="text-sm text-gray-500 mt-2 mb-6">You don't have enough balance to purchase this item.</p>
            <button id="insufficient-balance-deposit-btn" class="w-full p-3 rounded-xl btn-gradient">Deposit Now</button>
        </div>
    </div>

    <div id="purchase-success-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
        <div class="card-bg rounded-2xl p-6 w-full max-w-sm relative">
            <button id="close-purchase-success-modal" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="check" class="w-8 h-8 text-green-600"></i></div>
            <h3 class="text-xl font-bold text-gray-800 text-center mb-4">Successful!</h3>
            <div class="space-y-3 bg-gray-50 p-3 rounded-xl">
                <div class="flex items-center justify-between">
                    <span class="font-mono text-xs text-gray-800 truncate" id="purchase-success-email"></span>
                    <button onclick="copyToClipboard(document.getElementById('purchase-success-email').textContent, this)" class="p-1"><i data-lucide="copy" class="w-3 h-3 text-gray-500"></i></button>
                </div>
                <div class="flex items-center justify-between border-t border-gray-200 pt-2">
                    <span class="font-mono text-xs text-gray-800" id="purchase-success-password"></span>
                    <button onclick="copyToClipboard(document.getElementById('purchase-success-password').textContent, this)" class="p-1"><i data-lucide="copy" class="w-3 h-3 text-gray-500"></i></button>
                </div>
            </div>
            <button id="purchase-success-buy-again-btn" class="w-full p-3 rounded-xl btn-gradient mt-4">Buy Again</button>
        </div>
    </div>
    
    <div id="report-issue-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
        <div class="card-bg rounded-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-red-600">Report Issue</h3>
                <button onclick="document.getElementById('report-issue-modal').classList.add('hidden')" class="text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <p id="report-modal-mail-type" class="text-xs font-mono bg-gray-100 p-2 rounded mb-3 text-center"></p>
            <form id="report-issue-form" class="space-y-4">
                <input type="hidden" id="report-purchase-id">
                <input type="hidden" id="report-purchase-cost">
                <input type="hidden" id="report-purchase-saleId">
                <textarea id="report-reason" rows="3" class="w-full p-3 rounded-xl input-field text-sm" placeholder="Describe the problem..." required></textarea>
                <input type="text" id="report-proof" class="w-full p-3 rounded-xl input-field text-sm" placeholder="Link to screenshot (Optional)">
                <button type="submit" class="w-full p-3 rounded-xl btn-gradient text-sm">Submit Report</button>
            </form>
        </div>
    </div>

    <script type="module">
        const ADMIN_UID = "6954647230"; 

        // ========== CONFIGURATION (SETUP HERE) ==========
        const BOT_TOKEN = "8592535698:AAE2YXelHfTWHKcisFZjoB6K1l1OnuSq5Bg"; // FILL THIS (e.g., 123456:ABC-DEF...)
        const CHANNEL_ID = "@Earn_Fire"; // FILL THIS (e.g., @YourChannel)

        const firebaseConfig = {
            apiKey: "AIzaSyCoCy08FL_sHHdA0f2cJg0BaF-iYAhFuk0",
            authDomain: "mail-store-4692b.firebaseapp.com",
            databaseURL: "https://mail-store-4692b-default-rtdb.firebaseio.com",
            projectId: "mail-store-4692b",
            storageBucket: "mail-store-4692b.firebasestorage.app",
            messagingSenderId: "264936867411",
            appId: "1:264936867411:web:5933919e5bafae617968a6"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, runTransaction, getCountFromServer, writeBatch, updateDoc, Timestamp, onSnapshot, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUserTg = null;
        let userData = null;
        let appConfig = {};
        let insufficientBalanceInterval = null;

        const loader = document.getElementById('loader');

        const getLoadingHTML = () => `<div class="flex justify-center py-8"><div class="loader-spinner border-t-yellow-500 border-gray-200"></div></div>`;

        window.onload = async () => {
            cycleReviewsOnLoader();
            try {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setHeaderColor('#ffffff'); // Set header color
                currentUserTg = window.Telegram.WebApp.initDataUnsafe.user;
                
                if (!currentUserTg) {
                   // For testing in browser without Telegram
                   // currentUserTg = { id: 12345678, first_name: "Test", last_name: "User", username: "tester" };
                }

                if (!currentUserTg) {
                    showAlert("Please open this app from Telegram.");
                    loader.style.display = 'none';
                    return;
                }
            } catch (e) {
                console.error("Telegram WebApp Error", e);
                loader.style.display = 'none';
                return;
            }
            lucide.createIcons();
            setupEventListeners();
            setupBanner();

            await initUserSession();

            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
            }, 600);
        };

        function cycleReviewsOnLoader() {
            const reviews = [
                '"Best trusted server!" - Rayhan',
                '"Instant payment & delivery." - Faria',
                '"Earn Fire is the best." - Sumon'
            ];
            let reviewIndex = 0;
            const reviewEl = document.getElementById('loader-reviews');

            setInterval(() => {
                reviewEl.style.opacity = '0';
                setTimeout(() => {
                    reviewIndex = (reviewIndex + 1) % reviews.length;
                    reviewEl.textContent = reviews[reviewIndex];
                    reviewEl.style.opacity = '1';
                }, 500);
            }, 3000);
        }
        
        async function initUserSession() {
            if (!currentUserTg) return;
            const tgChatId = String(currentUserTg.id);
            const userRef = doc(db, "users", tgChatId);
            let userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                userData = userSnap.data();
                
                if (userData.isBlocked && userData.blockedUntil && userData.blockedUntil.toMillis() < Date.now()) {
                    await updateDoc(userRef, { isBlocked: false, blockedUntil: null, lastSeen: serverTimestamp() });
                    userSnap = await getDoc(userRef);
                    userData = userSnap.data();
                } else {
                    await updateDoc(userRef, {
                        name: `${currentUserTg.first_name || ''} ${currentUserTg.last_name || ''}`.trim(),
                        photo_url: currentUserTg.photo_url || null,
                        lastSeen: serverTimestamp()
                    });
                     userData.photo_url = currentUserTg.photo_url || null;
                     userData.name = `${currentUserTg.first_name || ''} ${currentUserTg.last_name || ''}`.trim();
                }
            } else {
                const userName = `${currentUserTg.first_name || ''} ${currentUserTg.last_name || ''}`.trim() || `User ${tgChatId}`;
                userData = {
                    tgChatId: tgChatId,
                    name: userName,
                    username: currentUserTg.username || null,
                    photo_url: currentUserTg.photo_url || null,
                    balance: 0,
                    createdAt: serverTimestamp(),
                    isBlocked: false,
                    blockedUntil: null, 
                    dailyRejections: { date: new Date().toISOString().slice(0, 10), count: 0 }, 
                    lastSeenNotification: null,
                    linkedUsers: [], 
                    linkedBy: null, 
                    teamSpending: {},
                    lastSeen: serverTimestamp(),
                    lastAutoMessage: null 
                };
                await setDoc(userRef, userData);
            }

            if (userData.isBlocked) {
                showAlert(`Account Blocked!`);
                return;
            }

            await fetchAppConfig();

            // --- Telegram Channel Check (Strict Mode) ---
            const isMember = await checkChannelMembership(tgChatId, CHANNEL_ID);
            if (!isMember) {
                document.getElementById('channel-lock-modal').classList.remove('hidden');
                loader.style.display = 'none';
                return; // STOP EXECUTION
            }
            
            await sendDailyWelcome(tgChatId);

            if (tgChatId === ADMIN_UID) {
                document.getElementById('admin-nav-link').classList.remove('hidden');
            }

            loadSupportMenu();
            updateUI();
            listenForNotifications();
            showMainPage('app-container');
            navigateTo('home-page');
        }

        async function fetchAppConfig() {
            const configRef = doc(db, "config", "main");
            const configSnap = await getDoc(configRef);
            appConfig = configSnap.exists() ? configSnap.data() : { mails: [] };
        }

        async function checkChannelMembership(userId, channelId) {
            if (!BOT_TOKEN) return true; // Bypass if no token
            
            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/getChatMember?chat_id=${channelId}&user_id=${userId}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.ok) {
                    const status = data.result.status;
                    return ["creator", "administrator", "member", "restricted"].includes(status);
                } else {
                    console.error("API Error:", data.description);
                    return false; 
                }
            } catch (error) {
                console.error("Membership check failed (likely CORS):", error);
                return true; // Bypass on network error to avoid blocking valid users unfairly
            }
        }

        async function sendDailyWelcome(userId) {
            if (!BOT_TOKEN) return;

            const now = Date.now();
            const lastMsgTime = userData.lastAutoMessage ? userData.lastAutoMessage.toMillis() : 0;
            const oneDay = 24 * 60 * 60 * 1000;

            if (now - lastMsgTime > oneDay) {
                try {
                    const message = "👋 Welcome back to Earn Fire! Check out our new stocks today.";
                    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${userId}&text=${encodeURIComponent(message)}`;
                    
                    fetch(url).catch(e => console.log("Auto msg err", e));
                    
                    await updateDoc(doc(db, "users", userId), { lastAutoMessage: Timestamp.now() });
                } catch (e) { console.error("Auto message setup failed", e); }
            }
        }
        
        function updateHeaderUI() {
            if (!currentUserTg) return;
            const profilePic = document.getElementById('header-profile-pic');
            const avatarDiv = document.getElementById('header-initials-avatar');
            const welcomeName = document.getElementById('header-welcome-name');

            if (userData.photo_url) {
                profilePic.src = userData.photo_url;
                profilePic.classList.remove('hidden');
                avatarDiv.classList.add('hidden');
            } else {
                const initials = (currentUserTg.first_name?.[0] || '') + (currentUserTg.last_name?.[0] || '');
                document.getElementById('header-initials').textContent = initials.toUpperCase();
                profilePic.classList.add('hidden');
                avatarDiv.classList.remove('hidden');
            }
            
            const firstName = currentUserTg.first_name || 'User';
            welcomeName.textContent = `Hi, ${firstName}!`;
        }

        function updateUI() {
            if (!userData) return;
            const balance = (userData.balance || 0).toFixed(2);
            document.getElementById('balance-display').textContent = `৳${balance}`;
            updateHeaderUI();
        }

        function showMainPage(pageId) {
            document.querySelectorAll('.main-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function navigateTo(pageId) {
            if (pageId !== 'mail-page' && insufficientBalanceInterval) {
                clearInterval(insufficientBalanceInterval);
                insufficientBalanceInterval = null;
            }

            const menu = document.getElementById('slide-out-menu');
            if(menu.classList.contains('open')) toggleMenu();

            document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            window.scrollTo(0, 0);

            document.querySelectorAll('.nav-link-premium[data-page]').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });

            const pageLoadFunctions = {
                'home-page': () => {},
                'pay-page': loadPaymentHistory,
                'mail-page': loadMailStore,
                'updates-page': () => { loadUpdates(); loadReviews(); },
                'admin-page': () => { populateAdminMailTypes(); loadReplaceRequests(); loadAdminSellRequests(); },
                'profile-page': loadProfilePage,
                'features-page': loadFeaturesPage,
                'tutorial-page': loadTutorials,
                'offer-page': () => { loadSellHistory(); loadTasks(); },
                'link-team-page': loadLinkedFriends,
                'send-page': () => { setupDynamicAmountHandlers('send'); },
                'notification-page': showNotifications,
                'report-history-page': loadReportHistory
            };
            if (pageLoadFunctions[pageId]) pageLoadFunctions[pageId]();
            lucide.createIcons();
        }
        window.navigateTo = navigateTo;

        window.toggleMenu = function() {
            const menu = document.getElementById('slide-out-menu');
            const overlay = document.getElementById('menu-overlay');
            menu.classList.toggle('open');
            if(menu.classList.contains('open')){
                overlay.style.opacity = '1';
                overlay.style.visibility = 'visible';
                menu.style.transform = 'translateX(0)';
            } else {
                overlay.style.opacity = '0';
                overlay.style.visibility = 'hidden';
                menu.style.transform = 'translateX(100%)';
            }
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.nav-link-premium[data-page]').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.page); }));
            document.getElementById('header-deposit-btn')?.addEventListener('click', () => navigateTo('pay-page'));
            document.getElementById('notification-btn').addEventListener('click', () => navigateTo('notification-page'));
            document.getElementById('deposit-btn').addEventListener('click', handleDepositRequest);
            document.getElementById('home-deposit-btn').addEventListener('click', () => navigateTo('pay-page'));
            document.getElementById('add-mails-btn').addEventListener('click', handleAddMails);
            document.getElementById('download-history-btn').addEventListener('click', handleDownloadHistory);
            document.getElementById('copy-history-btn').addEventListener('click', handleCopyHistory);
            document.getElementById('deposit-details-ok-btn').addEventListener('click', () => document.getElementById('deposit-details-modal').classList.add('hidden'));
            document.getElementById('hamburger-menu-btn').addEventListener('click', toggleMenu);
            document.getElementById('menu-overlay').addEventListener('click', toggleMenu);
            document.getElementById('go-to-support-btn').addEventListener('click', toggleMenu);
            document.getElementById('more-features-btn').addEventListener('click', handleFeaturesClick);
            document.getElementById('features-receive-btn').addEventListener('click', handleReceive);
            document.getElementById('features-send-btn').addEventListener('click', () => navigateTo('send-page'));
            document.getElementById('submit-send-btn').addEventListener('click', handleSendRequest);
            document.getElementById('search-friend-btn').addEventListener('click', handleSearchFriend);
            document.getElementById('add-task-btn').addEventListener('click', handleAddTask);
            document.getElementById('profile-tutorial-btn').addEventListener('click', () => navigateTo('tutorial-page'));
            document.getElementById('profile-report-history-btn').addEventListener('click', () => navigateTo('report-history-page'));
            document.getElementById('mail-details-ok-btn').addEventListener('click', () => { document.getElementById('mail-details-modal').classList.add('hidden'); });
            document.getElementById('close-insufficient-balance-modal').addEventListener('click', () => { document.getElementById('insufficient-balance-modal').classList.add('hidden'); });
            document.getElementById('insufficient-balance-deposit-btn').addEventListener('click', () => {
                document.getElementById('insufficient-balance-modal').classList.add('hidden');
                navigateTo('pay-page');
            });
            document.getElementById('alert-ok-btn').addEventListener('click', () => { document.getElementById('custom-alert').classList.add('hidden'); });
            const hidePurchaseSuccessModal = () => document.getElementById('purchase-success-modal').classList.add('hidden');
            document.getElementById('purchase-success-buy-again-btn').addEventListener('click', hidePurchaseSuccessModal);
            document.getElementById('close-purchase-success-modal').addEventListener('click', hidePurchaseSuccessModal);
            document.getElementById('report-issue-form').addEventListener('submit', handleReportSubmit);
        }

        window.switchOfferTab = (tab) => {
            document.querySelectorAll('.offer-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.offer-content-section').forEach(s => s.style.display = 'none');
            document.getElementById('offer-content-' + tab).style.display = 'block';
        }

        // --- SELL LOGIC ---
        window.handleSellRequest = async () => {
            const product = document.getElementById('sell-product-name').value;
            const details = document.getElementById('sell-details').value;
            const price = parseFloat(document.getElementById('sell-price').value);

            if (!product || !details || isNaN(price)) return showAlert("Please fill all fields correctly.");

            loader.style.display = 'flex';
            try {
                await addDoc(collection(db, "sell_requests"), {
                    userId: userData.tgChatId,
                    userName: userData.name,
                    product,
                    details,
                    price,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });
                showAlert("Sell Request Submitted!");
                document.getElementById('sell-product-name').value = '';
                document.getElementById('sell-details').value = '';
                document.getElementById('sell-price').value = '';
                loadSellHistory();
            } catch (e) { showAlert("Error submitting request."); }
            finally { loader.style.display = 'none'; }
        };

        async function loadSellHistory() {
            const list = document.getElementById('sell-history-list');
            list.innerHTML = getLoadingHTML();
            const q = query(collection(db, "sell_requests"), where("userId", "==", userData.tgChatId), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                list.innerHTML = '<p class="text-center text-gray-400 text-xs">No sell history.</p>';
                return;
            }

            list.innerHTML = snap.docs.map(doc => {
                const data = doc.data();
                const color = data.status === 'approved' ? 'text-green-600' : (data.status === 'rejected' ? 'text-red-600' : 'text-yellow-600');
                return `<div class="card-bg p-3 flex justify-between items-center">
                    <div><p class="font-bold text-sm text-gray-800">${data.product}</p><p class="text-[10px] text-gray-500">${data.createdAt?.toDate().toLocaleDateString()}</p></div>
                    <div class="text-right"><p class="font-bold text-sm">৳${data.price}</p><p class="text-[10px] font-bold uppercase ${color}">${data.status}</p></div>
                </div>`;
            }).join('');
        }

        // --- ADMIN SELL REQUESTS ---
        async function loadAdminSellRequests() {
            const list = document.getElementById('admin-sell-requests');
            list.innerHTML = getLoadingHTML();
            const q = query(collection(db, "sell_requests"), where("status", "==", "pending"));
            const snap = await getDocs(q);

            if (snap.empty) {
                list.innerHTML = '<p class="text-center text-gray-400 text-xs">No pending requests.</p>';
                return;
            }

            list.innerHTML = snap.docs.map(d => {
                const r = d.data();
                return `<div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                    <p class="text-xs font-bold text-gray-800">${r.userName} wants to sell ${r.product}</p>
                    <p class="text-[10px] text-gray-600 mt-1 font-mono bg-white p-1 rounded border">${r.details}</p>
                    <p class="text-xs font-bold mt-2">Price: ৳${r.price}</p>
                    <div class="flex gap-2 mt-3">
                        <button onclick="resolveSell('${d.id}', '${r.userId}', ${r.price}, true)" class="flex-1 py-2 bg-green-500 text-white text-[10px] font-bold rounded-lg uppercase">Approve</button>
                        <button onclick="resolveSell('${d.id}', '${r.userId}', 0, false)" class="flex-1 py-2 bg-red-500 text-white text-[10px] font-bold rounded-lg uppercase">Reject</button>
                    </div>
                </div>`;
            }).join('');
        }

        window.resolveSell = async (rid, uid, price, approve) => {
            if(!confirm(approve ? "Approve & Pay?" : "Reject?")) return;
            loader.style.display = 'flex';
            try {
                await runTransaction(db, async(t) => {
                    const rRef = doc(db, "sell_requests", rid);
                    const uRef = doc(db, "users", uid);
                    t.update(rRef, { status: approve ? 'approved' : 'rejected' });
                    if(approve) t.update(uRef, { balance: increment(price) });
                });
                showAlert("Success!");
                loadAdminSellRequests();
            } catch(e) { console.error(e); showAlert("Error."); }
            finally { loader.style.display = 'none'; }
        };

        // --- BEAUTIFIED TASKS ---
        async function loadTasks() {
            const container = document.getElementById('task-list-container');
            container.innerHTML = getLoadingHTML();
            try {
                const historyQ = query(collection(db, "task_history"), where("userId", "==", userData.tgChatId));
                const historySnap = await getDocs(historyQ);
                const completedTaskIds = new Set(historySnap.docs.map(d => d.data().taskId));

                const q = query(collection(db, "tasks"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);

                const activeTasks = snapshot.docs.filter(doc => !completedTaskIds.has(doc.id));

                if (activeTasks.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-4">No new tasks available.</p>`;
                    return;
                }
                
                container.innerHTML = activeTasks.map(doc => {
                    const t = doc.data();
                    const taskId = doc.id;
                    const isTelegram = t.type === 'telegram';
                    const icon = isTelegram ? 'send' : 'globe';
                    
                    const actionBtn = isTelegram 
                        ? `<button onclick="handleTelegramTask('${taskId}', '${t.link}', '${t.targetId}', ${t.amount})" class="px-4 py-2 bg-gray-900 text-yellow-500 text-[10px] font-black rounded-full uppercase shadow-lg">Start</button>`
                        : `<button onclick="handleWebTask('${taskId}', '${t.link}', ${t.amount})" class="px-4 py-2 bg-gray-900 text-yellow-500 text-[10px] font-black rounded-full uppercase shadow-lg">Visit</button>`;

                    return `<div class="task-item-premium" id="task-${taskId}">
                        <div class="flex items-center gap-3">
                            <div class="task-icon-box">
                                <i data-lucide="${icon}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-xs text-gray-800">${t.title}</h4>
                                <span class="task-reward-badge">৳${t.amount} REWARD</span>
                            </div>
                        </div>
                        <div id="action-area-${taskId}">${actionBtn}</div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            } catch (e) { container.innerHTML = "Error loading tasks"; console.error(e); }
        }

        window.handleTelegramTask = (taskId, link, channelUsername, reward) => {
            const area = document.getElementById(`action-area-${taskId}`);
            window.Telegram.WebApp.openLink(link);
            area.innerHTML = `<button onclick="verifyTelegramJoin('${taskId}', '${channelUsername}', ${reward})" class="px-4 py-2 bg-green-500 text-white text-[10px] font-black rounded-full uppercase animate-pulse">Verify</button>`;
        }

        window.verifyTelegramJoin = async (taskId, channelUsername, reward) => {
            loader.style.display = 'flex';
            try {
                const isMember = await checkChannelMembership(userData.tgChatId, channelUsername);
                if(isMember) {
                    await completeTask(taskId, reward);
                    document.getElementById(`task-${taskId}`).remove();
                    showAlert(`Success! ৳${reward} added.`);
                } else {
                    showAlert("You haven't joined the channel yet!");
                }
            } catch(e) {
                showAlert("Verification failed. Try again.");
            } finally {
                loader.style.display = 'none';
            }
        }

        window.handleWebTask = (taskId, link, reward) => {
            window.Telegram.WebApp.openLink(link);
            const area = document.getElementById(`action-area-${taskId}`);
            area.innerHTML = `<span class="text-xs text-gray-400 font-bold">Wait 8s...</span>`;
            setTimeout(() => {
                 area.innerHTML = `<button onclick="completeTask('${taskId}', ${reward}); document.getElementById('task-${taskId}').remove(); showAlert('Reward Added!');" class="px-4 py-2 bg-green-500 text-white text-[10px] font-black rounded-full uppercase">Claim</button>`;
            }, 8000);
        }

        async function completeTask(taskId, reward) {
            await runTransaction(db, async (t) => {
                const userRef = doc(db, "users", userData.tgChatId);
                const userSnap = await t.get(userRef);
                const newBalance = (userSnap.data().balance || 0) + parseFloat(reward);
                t.update(userRef, { balance: newBalance });
                t.set(doc(collection(db, "task_history")), { userId: userData.tgChatId, taskId: taskId, reward: reward, completedAt: serverTimestamp() });
            });
            userData.balance += parseFloat(reward);
            updateUI();
        }

        async function handleAddTask() {
            const type = document.getElementById('task-type').value;
            const title = document.getElementById('task-title').value;
            const reward = document.getElementById('task-reward').value;
            const amount = parseFloat(document.getElementById('task-amount').value);
            const link = document.getElementById('task-link').value;
            const targetId = document.getElementById('task-target-id').value; 

            if(!title || !reward || !amount || !link) return showAlert("Fill all fields");
            if(type === 'telegram' && !targetId) return showAlert("Channel Username required for API check");

            loader.style.display = 'flex';
            try {
                await addDoc(collection(db, "tasks"), { 
                    type, title, reward, amount, link, targetId, createdAt: serverTimestamp() 
                });
                showAlert("Task Added!");
                ['task-title','task-reward','task-amount','task-link','task-target-id'].forEach(id => document.getElementById(id).value = '');
            } catch(e) { showAlert("Error adding task"); }
            finally { loader.style.display = 'none'; }
        }

        window.switchMailView = (view) => {
            document.querySelectorAll('.mail-view-switcher button').forEach(b => b.classList.remove('active'));
            document.getElementById(`${view}-mail-btn`).classList.add('active');
            document.querySelectorAll('#mail-views-container > div').forEach(d => d.style.display = 'none');
            document.getElementById(`${view}-mail-container`).style.display = 'block';
        }

        function listenForNotifications() {
            const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const filteredDocs = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return !data.recipientId || data.recipientId === userData.tgChatId;
                });
                let unreadCount = 0;
                const lastSeen = userData.lastSeenNotification ? userData.lastSeenNotification.toMillis() : 0;
                filteredDocs.forEach(doc => { if (doc.data().createdAt.toMillis() > lastSeen) unreadCount++; });
                const badge = document.getElementById('notification-badge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        }

        async function showNotifications() {
            const listEl = document.getElementById('notification-list-full');
            listEl.innerHTML = getLoadingHTML();
            const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"), limit(20));
            const snapshot = await getDocs(q);
            const filteredDocs = snapshot.docs.filter(doc => {
                const data = doc.data();
                return !data.recipientId || data.recipientId === userData.tgChatId;
            });

            if (filteredDocs.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 mt-10">No notifications.</p>';
            } else {
                listEl.innerHTML = filteredDocs.map(doc => {
                    const item = doc.data();
                    const date = item.createdAt.toDate().toLocaleString('en-GB');
                    return `<div class="card-bg p-4 flex gap-3"><div class="shrink-0 pt-1"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center"><i data-lucide="info" class="w-4 h-4 text-blue-600"></i></div></div><div><h4 class="font-bold text-gray-800 text-sm">${item.title}</h4><p class="text-xs text-gray-600 mt-1 leading-relaxed">${item.message}</p><p class="text-[10px] text-gray-400 mt-2">${date}</p></div></div>`;
                }).join('');
                lucide.createIcons();
            }
            const userRef = doc(db, "users", userData.tgChatId);
            const newTimestamp = Timestamp.now();
            await updateDoc(userRef, { lastSeenNotification: newTimestamp });
            userData.lastSeenNotification = newTimestamp;
            document.getElementById('notification-badge').classList.add('hidden');
        }

        function loadProfilePage() {
            if (currentUserTg) {
                 if (userData.photo_url) {
                    document.getElementById('profile-pic').src = userData.photo_url;
                    document.getElementById('profile-pic').classList.remove('hidden');
                    document.getElementById('profile-initials-avatar').classList.add('hidden');
                } else {
                    const initials = (currentUserTg.first_name?.[0] || '') + (currentUserTg.last_name?.[0] || '');
                    document.getElementById('profile-initials').textContent = initials.toUpperCase();
                    document.getElementById('profile-pic').classList.add('hidden');
                    document.getElementById('profile-initials-avatar').classList.remove('hidden');
                }
                document.getElementById('profile-name').textContent = `${currentUserTg.first_name} ${currentUserTg.last_name || ''}`.trim();
                document.getElementById('profile-username').textContent = currentUserTg.username ? `@${currentUserTg.username}` : 'No Username';
                document.getElementById('profile-id').textContent = `ID: ${currentUserTg.id}`;
            }
        }

        async function handleDepositRequest() {
            const method = document.getElementById('deposit-method').value;
            const amount = parseInt(document.getElementById('deposit-amount').value);
            const senderNumber = document.getElementById('sender-number').value.trim();
            const transactionId = document.getElementById('deposit-txid').value.trim();
            if (!method || !amount || amount <= 0 || !senderNumber || !transactionId) return showAlert("Please fill all fields correctly.");
            loader.style.opacity = '1';
            loader.style.display = 'flex';
            try {
                const depositQuery = query(collection(db, "deposits"), where("transactionId", "==", transactionId), where("status", "in", ["pending", "approved"]));
                const querySnapshot = await getDocs(depositQuery);
                if (!querySnapshot.empty) {
                    loader.style.display = 'none';
                    return showAlert("This Transaction ID has already been used.");
                }
                await addDoc(collection(db, "deposits"), {
                    userId: userData.tgChatId, userName: userData.name, method: method, amount: amount,
                    senderNumber: senderNumber, transactionId: transactionId, status: "pending", requestedAt: serverTimestamp()
                });
                showAlert("Deposit request submitted successfully.");
                ['deposit-method', 'deposit-amount', 'sender-number', 'deposit-txid'].forEach(id => document.getElementById(id).value = '');
                loadPaymentHistory();
            } catch (error) { showAlert("Error submitting deposit."); } 
            finally { loader.style.display = 'none'; }
        }

        async function loadPaymentHistory() {
            const historyList = document.getElementById('payment-history-list');
            historyList.innerHTML = getLoadingHTML();
            try {
                const q = query(collection(db, "deposits"), where("userId", "==", userData.tgChatId), orderBy("requestedAt", "desc"), limit(10));
                const snapshot = await getDocs(q);
                if (snapshot.empty) return historyList.innerHTML = '<p class="text-gray-400 text-xs text-center">No transactions found.</p>';
                historyList.innerHTML = snapshot.docs.map(doc => {
                    const item = doc.data();
                    const statusColors = { approved: 'text-green-600', rejected: 'text-red-600', pending: 'text-yellow-600' };
                    const color = statusColors[item.status] || 'text-gray-600';
                    const date = item.requestedAt ? item.requestedAt.toDate().toLocaleDateString('en-GB') : 'N/A';
                    return `<div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between"><div class="flex items-center gap-3"><div class="p-2 bg-gray-50 rounded-lg"><i data-lucide="arrow-up-right" class="w-4 h-4 text-gray-500"></i></div><div><p class="font-bold text-sm text-gray-800">${item.method}</p><p class="text-[10px] text-gray-400">${date}</p></div></div><div class="text-right"><p class="font-bold text-sm text-gray-800">৳${item.amount}</p><p class="font-bold ${color} text-[10px] uppercase">${item.status}</p></div></div>`;
                }).join('');
                lucide.createIcons();
            } catch (error) { historyList.innerHTML = '<p class="text-red-400 text-xs text-center">Error loading history.</p>'; }
        }

        async function getStockCount(collectionName) {
            try {
                const q = query(collection(db, collectionName), where("isSold", "==", false));
                const snapshot = await getCountFromServer(q);
                return snapshot.data().count;
            } catch (error) { return 0; }
        }
        
        async function renderMailList(mails, containerEl, effectiveBalance) {
            if (!mails || mails.length === 0) {
                containerEl.innerHTML = `<p class="text-center text-gray-500 pt-10">এই ক্যাটাগরিতে কোনো মেইল উপলব্ধ নেই।</p>`;
                return;
            }
            const stockPromises = mails.map(mail => getStockCount(mail.stockKey));
            const stockCounts = await Promise.all(stockPromises);
            let mailsWithStock = mails.map((mail, index) => ({ ...mail, stock: stockCounts[index] })).sort((a, b) => b.stock - a.stock);

            containerEl.innerHTML = mailsWithStock.map(mail => {
                const isOutOfStock = mail.stock === 0;
                const insufficientBalance = effectiveBalance < mail.priceBdt;
                const buyButtonDisabled = isOutOfStock || insufficientBalance;
                const buyButtonClasses = buyButtonDisabled ? 'bg-gray-400 cursor-not-allowed' : 'btn-gradient';
                const validityTagHtml = (mail.expirationHours != null) ? `<span class="bg-blue-100 text-blue-700 text-xs font-semibold px-2 py-1 rounded-full">${mail.expirationHours}h validity</span>` : '';
                const apiButtonHtml = mail.apiLink ? `<button onclick="window.Telegram.WebApp.openLink('${mail.apiLink}')" class="text-blue-600 font-semibold">API</button>` : '<span class="text-gray-400 font-semibold">API</span>';
                const encodedDetails = encodeURIComponent(mail.details || '');
                const encodedFeatures = encodeURIComponent(JSON.stringify(mail.featureList || []));

                return `<div class="card-bg p-4 rounded-xl space-y-3"><div class="flex justify-between items-center"><div class="flex items-center gap-3"><img src="${mail.logoUrl}" class="w-8 h-8 rounded-lg object-cover" alt="${mail.type} logo"><h3 class="font-bold text-lg text-gray-800">${mail.type}</h3></div><div class="flex items-center gap-2">${validityTagHtml}<button onclick="showMailDetails('${mail.type}', '${encodedDetails}', '${encodedFeatures}')" class="text-blue-600 text-sm font-semibold">Details</button></div></div><div class="grid grid-cols-3 text-center items-center pt-2 border-t border-gray-100"><div class="py-2">${apiButtonHtml}</div><div class="py-2"><p class="text-gray-500 text-sm">Price</p><p class="font-bold text-lg text-blue-600">৳${parseFloat(mail.priceBdt).toFixed(2)}</p></div><div class="py-2"><p class="text-gray-500 text-sm">Stock</p><p class="font-bold text-lg text-green-600">${mail.stock}</p></div></div><button class="${buyButtonClasses} w-full py-2 rounded-lg text-md" ${buyButtonDisabled ? 'disabled' : ''} onclick="buyMail('${mail.type}', ${mail.priceBdt}, '${mail.stockKey}')">Buy Now</button></div>`;
            }).join('');
            lucide.createIcons();
        }

        async function loadMailStore() {
            const loginMailContainer = document.getElementById('login-mail-container');
            const otpMailContainer = document.getElementById('otp-mail-container');
            const accountMailContainer = document.getElementById('account-mail-container');
            const numberMailContainer = document.getElementById('number-mail-container');
            const historyListEl = document.getElementById('mail-purchase-history');
            
            [loginMailContainer, otpMailContainer, accountMailContainer, numberMailContainer, historyListEl].forEach(el => el.innerHTML = getLoadingHTML());
            
            try {
                const userSnap = await getDoc(doc(db, "users", userData.tgChatId));
                userData = userSnap.data();

                let effectiveBalance = userData.balance;
                if (userData.linkedBy) {
                    const teamLeaderSnap = await getDoc(doc(db, "users", userData.linkedBy));
                    if (teamLeaderSnap.exists()) effectiveBalance += teamLeaderSnap.data().balance;
                }

                const allMails = appConfig.mails || [];
                const loginMails = allMails.filter(m => m.category === 'login' || !m.category);
                const otpMails = allMails.filter(m => m.category === 'otp');
                const accountMails = allMails.filter(m => m.category === 'account');
                const numberMails = allMails.filter(m => m.category === 'number');

                await Promise.all([
                    renderMailList(loginMails, loginMailContainer, effectiveBalance),
                    renderMailList(otpMails, otpMailContainer, effectiveBalance),
                    renderMailList(accountMails, accountMailContainer, effectiveBalance),
                    renderMailList(numberMails, numberMailContainer, effectiveBalance)
                ]);
                
                const activeBtn = document.querySelector('.mail-view-switcher button.active');
                if(activeBtn) {
                     const view = activeBtn.id.split('-')[0]; 
                     switchMailView(view);
                } else {
                     switchMailView('login');
                }

                const twentyFourHoursAgo = Timestamp.fromDate(new Date(Date.now() - 24 * 60 * 60 * 1000));
                const q = query(collection(db, "mail_purchases"), where("userId", "==", userData.tgChatId), where("purchasedAt", ">=", twentyFourHoursAgo), orderBy("purchasedAt", "desc"));
                const querySnapshot = await getDocs(q);

                const purchaseIds = querySnapshot.docs.map(d => d.id);
                const reportStatusMap = new Map();
                if (purchaseIds.length > 0) {
                     const rQ = query(collection(db, "replace_requests"), where("purchaseId", "in", purchaseIds.slice(0, 10))); 
                     const rSnap = await getDocs(rQ);
                     rSnap.forEach(d => reportStatusMap.set(d.data().purchaseId, d.data().status));
                }

                const activePurchases = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.isRefunded);

                if(activePurchases.length === 0) {
                    historyListEl.innerHTML = '<p class="text-center text-gray-600">আপনার কোনো সক্রিয় কেনা মেইল নেই।</p>';
                } else {
                    historyListEl.innerHTML = activePurchases.map(purchase => {
                        const date = purchase.purchasedAt.toDate().toLocaleString();
                        const fullData = [purchase.mail, purchase.password, purchase.refreshToken, purchase.clientId].filter(Boolean).join('|');
                        const reportStatus = reportStatusMap.get(purchase.id);
                        let reportButton;
                        switch (reportStatus) {
                            case 'approved': reportButton = `<button class="bg-green-100 text-green-700 text-xs px-3 py-1.5 rounded-md font-semibold flex items-center gap-1" disabled><i data-lucide="check-circle" class="w-3 h-3"></i> Refunded</button>`; break;
                            case 'rejected': reportButton = `<button class="bg-gray-200 text-gray-600 text-xs px-3 py-1.5 rounded-md font-semibold flex items-center gap-1" disabled><i data-lucide="x-circle" class="w-3 h-3"></i> Rejected</button>`; break;
                            case 'pending': reportButton = `<button class="bg-yellow-100 text-yellow-700 text-xs px-3 py-1.5 rounded-md font-semibold flex items-center gap-1" disabled><i data-lucide="hourglass" class="w-3 h-3"></i> Pending</button>`; break;
                            default: reportButton = `<button id="report-btn-${purchase.id}" onclick="showReportForm('${purchase.id}', '${purchase.mailType}', ${purchase.cost}, '${purchase.saleId}')" class="bg-orange-100 text-orange-700 text-xs px-3 py-1.5 rounded-md font-semibold hover:bg-orange-200 flex items-center gap-1"><i data-lucide="shield-alert" class="w-3 h-3"></i> Report Issue</button>`;
                        }
                        return `<div class="card-bg p-4 rounded-xl space-y-3"><div class="flex justify-between items-start"><div><h4 class="font-bold text-lg text-gray-800">${purchase.mailType}</h4><p class="text-xs text-gray-500">${date}</p><p class="text-xs font-mono text-blue-600 mt-1">ID: ${purchase.saleId || 'N/A'}</p></div><div class="flex flex-col items-end gap-2">${reportButton}<button onclick="copyToClipboard('${fullData}', this)" class="bg-gray-100 text-gray-700 text-xs px-3 py-1.5 rounded-md font-semibold hover:bg-gray-200 flex items-center gap-1"><i data-lucide="copy-plus" class="w-3 h-3"></i> FULL COPY</button></div></div><div class="space-y-2 pt-2 border-t"><div class="flex items-center justify-between bg-gray-50 p-2 rounded-md"><span class="text-sm font-medium text-gray-500 mr-2">EMAIL:</span><span class="font-mono text-sm text-gray-800 truncate">${purchase.mail}</span><button onclick="copyToClipboard('${purchase.mail}', this)" class="ml-2 p-1.5 rounded-md hover:bg-gray-200"><i data-lucide="copy" class="w-4 h-4 text-gray-600"></i></button></div><div class="flex items-center justify-between bg-gray-50 p-2 rounded-md"><span class="text-sm font-medium text-gray-500 mr-2">PASS:</span><span class="font-mono text-sm text-gray-800">${purchase.password || 'N/A'}</span><button onclick="copyToClipboard('${purchase.password || ''}', this)" class="ml-2 p-1.5 rounded-md hover:bg-gray-200"><i data-lucide="copy" class="w-4 h-4 text-gray-600"></i></button></div></div></div>`;
                    }).join('');
                }
                lucide.createIcons();
            } catch(e) { historyListEl.innerHTML = '<p class="text-center text-red-400 text-xs">Error loading history.</p>'; }
        }
        
        async function handleDownloadHistory() {
            loader.style.display = 'flex';
            try {
                const q = query(collection(db, "mail_purchases"), where("userId", "==", userData.tgChatId), orderBy("purchasedAt", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    loader.style.display = 'none';
                    return showAlert("No history found.");
                }
                const dataForExcel = querySnapshot.docs.map(doc => { const p = doc.data(); return { 'Date': p.purchasedAt.toDate().toLocaleString(), 'Type': p.mailType, 'Email': p.mail, 'Password': p.password || 'N/A', 'Cost': p.cost, 'Full Data': [p.mail,p.password,p.refreshToken,p.clientId].filter(Boolean).join('|') }; });
                const ws = XLSX.utils.json_to_sheet(dataForExcel);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "History");
                XLSX.writeFile(wb, "EARN_FIRE_History.xlsx");
            } catch (error) { showAlert("Error downloading."); }
            finally { loader.style.display = 'none'; }
        }

        async function handleCopyHistory() {
             loader.style.display = 'flex';
            try {
                const fourHoursAgo = Timestamp.fromDate(new Date(Date.now() - 4 * 60 * 60 * 1000));
                const q = query(collection(db, "mail_purchases"), where("userId", "==", userData.tgChatId), where("purchasedAt", ">=", fourHoursAgo), orderBy("purchasedAt", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    loader.style.display = 'none';
                    return showAlert("No recent history (last 4h).");
                }
                const contentToCopy = querySnapshot.docs.map(doc => { const p = doc.data(); return `${p.mailType}:${p.mail}:${p.password || ''}`; }).join('\n');
                copyToClipboard(contentToCopy, null, 'Copied last 4h history!');
            } catch (error) { showAlert("Error copying."); }
            finally { loader.style.display = 'none'; }
        }

        // ============ FIXED TRANSACTION LOGIC ============
        window.buyMail = async function(mailType, costParam, stockKey) {
            const cost = parseFloat(costParam);
            if (!confirm(`Confirm purchase of ${mailType} for ৳${cost.toFixed(2)}?`)) return;

            loader.style.display = 'flex';
            
            try {
                // Step 1: Find a candidate mail OUTSIDE transaction (To avoid complex query errors in Tx)
                const q = query(collection(db, stockKey), where("isSold", "==", false), limit(1));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) throw "Out of Stock";
                const candidateMailDoc = snapshot.docs[0];

                await runTransaction(db, async (transaction) => {
                    const buyerRef = doc(db, "users", userData.tgChatId);
                    const counterRef = doc(db, "counters", "mail_purchase");
                    const mailRef = candidateMailDoc.ref; // Use the specific ref found earlier
                    
                    // ALL READS MUST BE HERE (Top of transaction block)
                    const buyerSnap = await transaction.get(buyerRef);
                    const counterSnap = await transaction.get(counterRef);
                    const mailSnap = await transaction.get(mailRef); // Check again if it's still unsold

                    if (!buyerSnap.exists()) throw "User Error";
                    if (!mailSnap.exists() || mailSnap.data().isSold) throw "Race Condition"; // Someone else bought it ms ago

                    let currentBuyerData = buyerSnap.data();
                    let teamLeaderRef = null;
                    let currentLeaderData = null;

                    // Read Team Leader if needed (Must be done before writes too)
                    if (currentBuyerData.linkedBy) {
                        teamLeaderRef = doc(db, "users", currentBuyerData.linkedBy);
                        const leaderSnap = await transaction.get(teamLeaderRef);
                        if (leaderSnap.exists()) currentLeaderData = leaderSnap.data();
                    }

                    // --- LOGIC STARTS HERE ---
                    const effectiveBalance = currentBuyerData.balance + (currentLeaderData ? currentLeaderData.balance : 0);
                    if (effectiveBalance < cost) throw "Insufficient Balance";

                    const mailData = mailSnap.data();
                    let costRemaining = cost;
                    let paidBy = 'self';
                    let buyerDeduction = Math.min(costRemaining, currentBuyerData.balance);
                    
                    // --- WRITES START HERE ---
                    if (buyerDeduction > 0) {
                        transaction.update(buyerRef, { balance: currentBuyerData.balance - buyerDeduction });
                        costRemaining -= buyerDeduction;
                    }
                    if (costRemaining > 0 && teamLeaderRef) {
                        transaction.update(teamLeaderRef, { balance: currentLeaderData.balance - costRemaining });
                        const newSpending = (currentLeaderData.teamSpending?.[userData.tgChatId] || 0) + costRemaining;
                        transaction.update(teamLeaderRef, { [`teamSpending.${userData.tgChatId}`]: newSpending });
                        paidBy = currentBuyerData.linkedBy;
                    }

                    transaction.update(mailRef, { isSold: true, soldTo: userData.tgChatId, soldAt: serverTimestamp() });
                    
                    const saleId = counterSnap.exists() ? counterSnap.data().currentId + 1 : 1;
                    transaction.set(counterRef, { currentId: saleId }, { merge: true });

                    const newPurchaseRef = doc(collection(db, "mail_purchases"));
                    const mailConfig = appConfig.mails.find(m => m.stockKey === stockKey);
                    
                    transaction.set(newPurchaseRef, {
                        saleId: saleId, userId: userData.tgChatId, paidBy: paidBy, mailType: mailType,
                        mail: mailData.email, password: mailData.password || null,
                        refreshToken: mailData.refresh_token || null, clientId: mailData.client_id || null,
                        cost: cost, purchasedAt: serverTimestamp(),
                        expirationHours: mailConfig ? mailConfig.expirationHours : null
                    });
                    
                    userData.balance = currentBuyerData.balance - buyerDeduction;
                    
                    // Update UI immediately for success modal
                    document.getElementById('purchase-success-email').textContent = mailData.email;
                    document.getElementById('purchase-success-password').textContent = mailData.password || 'N/A';
                });

                document.getElementById('purchase-success-modal').classList.remove('hidden');
                updateUI();
                loadMailStore(); 
            } catch (e) { 
                if (e === "Insufficient Balance") {
                    document.getElementById('insufficient-balance-modal').classList.remove('hidden');
                } else if (e === "Out of Stock" || e === "Race Condition") {
                    showAlert("Sorry, this item was just sold or is out of stock. Please try again.");
                    loadMailStore();
                } else {
                    console.error(e);
                    showAlert("Transaction failed. Try again.");
                }
            } finally { 
                loader.style.display = 'none';
            }
        }
        // ===============================================

        window.showMailDetails = function(mailType, encodedDetails, encodedFeatures) {
            const details = decodeURIComponent(encodedDetails);
            const features = JSON.parse(decodeURIComponent(encodedFeatures));
            
            let contentHTML = `<p>${details}</p>`;
            if (features && features.length > 0) {
                const list = features.map(f => `<div class="flex items-start gap-3 mt-2"><i data-lucide="shield-check" class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5"></i><span class="text-sm text-gray-800">${f}</span></div>`).join('');
                contentHTML += `<div class="mt-4 pt-3 border-t border-gray-200"><h4 class="font-semibold text-gray-800 mb-2">Features:</h4>${list}</div>`;
            }
            document.getElementById('mail-details-title').textContent = `${mailType} Details`;
            document.getElementById('mail-details-content').innerHTML = contentHTML;
            document.getElementById('mail-details-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        window.toggleUpdateContent = (updateId, encodedContent) => {
            const contentEl = document.getElementById(`update-content-${updateId}`);
            const buttonEl = contentEl.nextElementSibling;
            const fullContent = decodeURIComponent(encodedContent);
            if (buttonEl.innerText === "Read More") {
                contentEl.innerText = fullContent;
                buttonEl.innerText = "Show Less";
            } else {
                contentEl.innerText = fullContent.substring(0, 120) + '...';
                buttonEl.innerText = "Read More";
            }
        }

        async function loadUpdates() {
            const updatesContainer = document.getElementById('updates-content');
            updatesContainer.innerHTML = getLoadingHTML();
            try {
                const q = query(collection(db, "updates"), orderBy("createdAt", "desc"), limit(1));
                const snapshot = await getDocs(q);
                if (snapshot.empty) return updatesContainer.innerHTML = `<div class="card-bg p-6 rounded-2xl text-center"><h3 class="font-bold text-xl text-gray-800">No new updates right now!</h3><p class="text-gray-600 mt-2">Check back later.</p></div>`;

                const updateDoc = snapshot.docs[0];
                const update = { id: updateDoc.id, ...updateDoc.data() };
                const content = update.content || '';
                const shortContent = content.length > 120 ? content.substring(0, 120) + '...' : content;
                const encodedContent = encodeURIComponent(content);
                const date = update.createdAt ? update.createdAt.toDate().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : '';

                updatesContainer.innerHTML = `<div class="card-bg rounded-2xl overflow-hidden shadow-lg flex flex-col">${update.imageUrl ? `<img src="${update.imageUrl}" class="w-full aspect-[16/9] object-cover" alt="Update Banner">` : ''}<div class="p-5 space-y-3"><div><h3 class="text-xl font-bold text-gray-800">${update.title}</h3>${date ? `<p class="text-xs text-gray-500 mt-1">${date}</p>` : ''}</div><p id="update-content-${update.id}" class="text-gray-600 text-sm whitespace-pre-wrap leading-relaxed">${shortContent}</p>${content.length > 120 ? `<button onclick="toggleUpdateContent('${update.id}', '${encodedContent}')" class="font-semibold text-blue-600 text-sm hover:underline">Read More</button>` : ''}</div></div>`;
                lucide.createIcons();
            } catch(e) {
                updatesContainer.innerHTML = `<p class="text-center text-red-600">Failed to load updates.</p>`;
                console.error("Error loading updates:", e);
            }
        }
        
        function populateAdminMailTypes() {
            const selectEl = document.getElementById('mail-type-select');
            selectEl.innerHTML = '<option value="">Select Type</option>';
            (appConfig.mails || []).forEach(mail => { selectEl.innerHTML += `<option value="${mail.stockKey}">${mail.type}</option>`; });
        }

        async function handleAddMails() {
            const stockKey = document.getElementById('mail-type-select').value;
            const data = document.getElementById('mail-data-textarea').value;
            if(!stockKey || !data) return showAlert("Invalid Input");
            loader.style.display = 'flex';
            const batch = writeBatch(db);
            const lines = data.trim().split('\n');
            let count = 0;
            lines.forEach(line => {
                const parts = line.trim().split('/');
                if(parts.length >= 2) {
                     const ref = doc(collection(db, stockKey));
                     batch.set(ref, { email: parts[0], password: parts[1], refresh_token: parts[2]||null, client_id: parts[3]||null, isSold: false, createdAt: serverTimestamp() });
                     count++;
                }
            });
            await batch.commit();
            loader.style.display = 'none';
            showAlert(`${count} mails added to STOCK.`);
            document.getElementById('mail-data-textarea').value = '';
        }

        function showAlert(message) {
            document.getElementById('alert-message').innerText = message;
            document.getElementById('custom-alert').classList.remove('hidden');
        }

        window.copyToClipboard = function(text, element, alertMsg) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                if(element) {
                     const original = element.innerHTML;
                     element.innerHTML = `<i data-lucide="check" class="w-3 h-3 text-green-500"></i>`;
                     lucide.createIcons();
                     setTimeout(() => { element.innerHTML = original; lucide.createIcons(); }, 1000);
                } else {
                    showAlert(alertMsg || "Copied!");
                }
            });
        }

        function setupBanner() {
            const slides = document.querySelectorAll('.slide');
            const slideContainer = document.getElementById('slides');
            const dotsContainer = document.getElementById('dots');
            if (slides.length <= 1) return;
            let index = 0;
            dotsContainer.innerHTML = Array.from(slides).map((_, i) => `<span class="dot ${i === 0 ? 'active' : ''}" data-index="${i}"></span>`).join('');
            const dots = dotsContainer.querySelectorAll('.dot');
            const showSlide = (i) => {
                index = i;
                slideContainer.style.transform = `translateX(${-i * 100}%)`;
                dots.forEach(d => d.classList.remove('active'));
                dots[i].classList.add('active');
            };
            setInterval(() => showSlide((index + 1) % slides.length), 4000);
        }

        async function loadFeaturesPage() {
            const receivedQuery = query(collection(db, "transfers"), where("toId", "==", userData.tgChatId));
            const sentQuery = query(collection(db, "transfers"), where("fromId", "==", userData.tgChatId));
            const [rSnap, sSnap] = await Promise.all([getDocs(receivedQuery), getDocs(sentQuery)]);
            
            const rTotal = rSnap.docs.reduce((sum, d) => sum + d.data().amount, 0);
            const sTotal = sSnap.docs.reduce((sum, d) => sum + d.data().amount, 0);
            
            document.getElementById('total-receive-display').textContent = `৳${rTotal.toFixed(2)}`;
            document.getElementById('total-send-display').textContent = `৳${sTotal.toFixed(2)}`;
            loadTransferHistory();
        }

        async function loadTransferHistory() {
            const list = document.getElementById('transfer-history-list');
            list.innerHTML = getLoadingHTML();
            const q = query(collection(db, "transfers"), where("fromId", "==", userData.tgChatId), limit(5));
            const s = await getDocs(q);
            if(s.empty) return list.innerHTML = '<p class="text-center text-gray-400 text-xs">No transfers.</p>';
            list.innerHTML = s.docs.map(d => {
                const t = d.data();
                return `<div class="card-bg p-3 flex justify-between"><span class="text-xs font-bold text-gray-700">Sent to ${t.toName}</span><span class="text-xs font-bold text-red-500">-৳${t.amount}</span></div>`;
            }).join('');
        }

        function handleReceive() {
            copyToClipboard(userData.tgChatId, null, `Your Receive ID: ${userData.tgChatId}`);
        }

        function setupDynamicAmountHandlers(type) {
             const inp = document.getElementById(`${type}-amount`);
             const dis = document.getElementById(`${type}-fee-display`);
             inp.addEventListener('input', () => {
                 const val = parseFloat(inp.value) || 0;
                 dis.textContent = val > 0 ? `Fee (5%): ৳${(val*0.05).toFixed(2)}` : '';
             });
        }
        
        async function handleSendRequest() {
            const toId = document.getElementById('send-recipient-id').value.trim();
            const amount = parseFloat(document.getElementById('send-amount').value);
            if(!toId || amount < 20) return showAlert("Invalid details. Min amount 20.");
            if(toId === userData.tgChatId) return showAlert("Cannot send to self.");
            
            const total = amount * 1.05;
            if(userData.balance < total) return showAlert("Insufficient balance including fee.");
            
            if(!confirm(`Send ৳${amount} to ${toId}? Total cost ৳${total.toFixed(2)}`)) return;
            
            loader.style.display = 'flex';
            try {
                await runTransaction(db, async(t) => {
                    const senderRef = doc(db, "users", userData.tgChatId);
                    const recRef = doc(db, "users", toId);
                    const sSnap = await t.get(senderRef);
                    const rSnap = await t.get(recRef);
                    if(!rSnap.exists()) throw "Recipient not found.";
                    if(sSnap.data().balance < total) throw "Low Balance";
                    
                    t.update(senderRef, { balance: sSnap.data().balance - total });
                    t.update(recRef, { balance: rSnap.data().balance + amount });
                    t.set(doc(collection(db, "transfers")), { fromId: userData.tgChatId, toId: toId, amount: amount, fee: amount*0.05, timestamp: serverTimestamp() });
                });
                userData.balance -= total;
                showAlert("Sent Successfully!");
                navigateTo('features-page');
            } catch(e) { showAlert(e); }
            finally { loader.style.display = 'none'; }
        }

        async function handleSearchFriend() {
            const fid = document.getElementById('link-friend-id').value.trim();
            if(!fid) return;
            const snap = await getDoc(doc(db, "users", fid));
            if(!snap.exists()) return document.getElementById('friend-search-result').innerHTML = "<p class='text-red-500 text-xs'>User not found.</p>";
            document.getElementById('friend-search-result').innerHTML = `<div class="bg-gray-100 p-2 rounded flex justify-between items-center mt-2"><span class="text-sm font-bold">${snap.data().name}</span><button onclick="linkFriend('${fid}')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded">Link</button></div>`;
        }
        
        window.linkFriend = async (fid) => {
            await updateDoc(doc(db, "users", userData.tgChatId), { linkedUsers: arrayUnion(fid) });
            await updateDoc(doc(db, "users", fid), { linkedBy: userData.tgChatId });
            showAlert("Linked!");
            loadLinkedFriends();
            document.getElementById('friend-search-result').innerHTML = '';
            document.getElementById('link-friend-id').value = '';
        }

        async function loadLinkedFriends() {
             const list = document.getElementById('linked-friends-list');
             list.innerHTML = getLoadingHTML();
             const snap = await getDoc(doc(db, "users", userData.tgChatId));
             const linked = snap.data().linkedUsers || [];
             if(linked.length === 0) return list.innerHTML = '<p class="text-gray-400 text-xs text-center">No team members.</p>';
             
             let html = '';
             for(const uid of linked) {
                 const f = await getDoc(doc(db, "users", uid));
                 if(f.exists()) {
                     const spent = userData.teamSpending?.[uid] || 0;
                     html += `<div class="card-bg p-3 flex justify-between items-center"><div><p class="font-bold text-sm text-gray-800">${f.data().name}</p><p class="text-[10px] text-gray-500">Spent: ৳${spent.toFixed(2)}</p></div><button onclick="unlink('${uid}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                 }
             }
             list.innerHTML = html;
             lucide.createIcons();
        }
        
        window.unlink = async (uid) => {
             if(!confirm("Remove user?")) return;
             await updateDoc(doc(db, "users", userData.tgChatId), { linkedUsers: arrayRemove(uid) });
             await updateDoc(doc(db, "users", uid), { linkedBy: null });
             loadLinkedFriends();
        }

        async function loadTutorials() {
            const list = document.getElementById('tutorial-list');
            list.innerHTML = getLoadingHTML();
            try {
                const q = query(collection(db, "tutorials"), orderBy("order"));
                const s = await getDocs(q);
                if(s.empty) return list.innerHTML = '<p class="text-center text-gray-400">No tutorials.</p>';
                list.innerHTML = s.docs.map(d => {
                    const t = d.data();
                    return `<a href="${t.youtubeWatchUrl}" target="_blank" class="block card-bg overflow-hidden group"><img src="${t.bannerImageUrl}" class="w-full h-32 object-cover group-hover:opacity-90"><div class="p-3"><h4 class="font-bold text-sm text-gray-800">${t.title}</h4></div></a>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        async function loadReviews() {
             const list = document.getElementById('reviews-list');
             list.innerHTML = getLoadingHTML();
             const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"), limit(5));
             const s = await getDocs(q);
             if(s.empty) return list.innerHTML = '<p class="text-center text-gray-600">No reviews yet.</p>';

             list.innerHTML = s.docs.map(doc => {
                 const review = doc.data();
                 const stars = Array(5).fill(0).map((_, i) => `<i data-lucide="star" class="w-4 h-4 ${i < review.rating ? 'fill-current' : ''}"></i>`).join('');
                 const imageUrl = review.imageUrl || `https://ui-avatars.com/api/?name=${review.name.replace(/\s/g, "+")}&background=random`;
                 return `<div class="review-card-new p-4 rounded-lg"><div class="flex items-start gap-4"><img src="${imageUrl}" class="w-12 h-12 rounded-full object-cover" alt="User"><div class="flex-1"><div class="flex justify-between items-center"><h5 class="font-bold">${review.name}</h5><div class="star-rating flex text-sm">${stars}</div></div><p class="text-gray-600 text-sm mt-1">"${review.reviewText}"</p></div></div></div>`;
             }).join('');
             lucide.createIcons();
        }

        async function loadSupportMenu() {
            const list = document.getElementById('support-channels-list');
            const channels = [
                { name: "Telegram Channel", iconColor: "bg-blue-100 text-blue-600", icon: "send", link: "https://t.me/your_channel_link" },
                { name: "WhatsApp Support", iconColor: "bg-green-100 text-green-600", icon: "message-circle", link: "https://wa.me/your_number" },
                { name: "Online Chat", iconColor: "bg-orange-100 text-orange-600", icon: "message-square", link: "https://t.me/your_support_user" },
                { name: "Email Support", iconColor: "bg-gray-100 text-gray-600", icon: "mail", link: "mailto:support@earnfire.com" }
            ];
            list.innerHTML = channels.map(c => `<a href="${c.link}" target="_blank" onclick="handleMenuLinkClick(event)" class="support-item group"><div class="flex items-center"><div class="support-icon ${c.iconColor}"><i data-lucide="${c.icon}" class="w-6 h-6"></i></div><span class="font-bold text-sm text-gray-700">${c.name}</span></div><i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 group-hover:text-indigo-500 transition-colors"></i></a>`).join('');
            lucide.createIcons();
        }
        
        window.handleMenuLinkClick = (e) => {
            setTimeout(() => {
                const menu = document.getElementById('slide-out-menu');
                if(menu.classList.contains('open')) toggleMenu();
            }, 8000);
        }

        function handleFeaturesClick() { navigateTo('features-page'); }
        
        window.showReportForm = (pid, type, cost, sid) => {
            document.getElementById('report-modal-mail-type').textContent = `${type} #${sid}`;
            document.getElementById('report-purchase-id').value = pid;
            document.getElementById('report-purchase-cost').value = cost;
            document.getElementById('report-purchase-saleId').value = sid;
            document.getElementById('report-issue-modal').classList.remove('hidden');
        }
        
        async function handleReportSubmit(e) {
            e.preventDefault();
            const pid = document.getElementById('report-purchase-id').value;
            const reason = document.getElementById('report-reason').value;
            const proof = document.getElementById('report-proof').value;
            loader.style.display = 'flex';
            try {
                await addDoc(collection(db, "replace_requests"), {
                    userId: userData.tgChatId, userName: userData.name, purchaseId: pid, reason, proof, status: 'pending', requestedAt: serverTimestamp(),
                    mailType: document.getElementById('report-modal-mail-type').textContent, cost: parseFloat(document.getElementById('report-purchase-cost').value)
                });
                showAlert("Report Submitted.");
                document.getElementById('report-issue-modal').classList.add('hidden');
                loadMailStore();
            } catch(er) { showAlert("Error submitting report."); }
            finally { loader.style.display = 'none'; }
        }
        
        async function loadReportHistory() {
             const list = document.getElementById('report-history-list');
             list.innerHTML = getLoadingHTML();
             const q = query(collection(db, "replace_requests"), where("userId", "==", userData.tgChatId), orderBy("requestedAt", "desc"));
             const s = await getDocs(q);
             if(s.empty) return list.innerHTML = '<p class="text-center text-gray-400">No reports.</p>';
             list.innerHTML = s.docs.map(d => {
                 const r = d.data();
                 return `<div class="card-bg p-3"><div class="flex justify-between"><span class="font-bold text-sm">${r.mailType}</span><span class="text-[10px] uppercase font-bold text-gray-500">${r.status}</span></div><p class="text-xs text-gray-600 mt-1">"${r.reason}"</p></div>`;
             }).join('');
        }
        
        async function loadReplaceRequests() {
             const list = document.getElementById('replace-requests-list');
             list.innerHTML = getLoadingHTML();
             const q = query(collection(db, "replace_requests"), where("status", "==", "pending"));
             const s = await getDocs(q);
             if(s.empty) return list.innerHTML = '<p class="text-center text-gray-400">No pending requests.</p>';
             list.innerHTML = s.docs.map(d => {
                 const r = d.data();
                 return `<div class="card-bg p-3 space-y-2"><p class="text-sm font-bold">${r.userName} - ${r.mailType}</p><p class="text-xs italic">${r.reason}</p><div class="flex gap-2"><button onclick="resolveReq('${d.id}', '${r.userId}', ${r.cost}, '${r.purchaseId}', true)" class="bg-green-500 text-white text-xs px-3 py-1 rounded">Refund</button><button onclick="resolveReq('${d.id}', '${r.userId}', 0, null, false)" class="bg-red-500 text-white text-xs px-3 py-1 rounded">Reject</button></div></div>`;
             }).join('');
        }
        
        window.resolveReq = async (rid, uid, cost, pid, approve) => {
             if(!confirm(approve ? "Refund user?" : "Reject report?")) return;
             loader.style.display = 'flex';
             try {
                 await runTransaction(db, async(t) => {
                     const rRef = doc(db, "replace_requests", rid);
                     t.update(rRef, { status: approve ? 'approved' : 'rejected', resolvedAt: serverTimestamp() });
                     if(approve) {
                         const uRef = doc(db, "users", uid);
                         const pRef = doc(db, "mail_purchases", pid);
                         t.update(uRef, { balance: increment(cost) });
                         t.update(pRef, { isRefunded: true });
                     }
                 });
                 loadReplaceRequests();
             } catch(e) { showAlert("Error resolving."); }
             finally { loader.style.display = 'none'; }
        }

    </script>
</body>  
</html>
